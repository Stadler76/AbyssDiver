
'''
CURSE_NAMES
[
'ALittleExtra', 'AMouthful', 'AbsoluteBirthControl', 'AbsolutePregnancy',
'AdversePossession', 'AgeReductionA', 'AgeReductionB', 'AgeReductionC',
'AmpuQtie', 'ArmArmy', 'AssetRobustnessA', 'AssetRobustnessB', 'AssetRobustnessC',
'AssetRobustnessD', 'AssetRobustnessE', 'AssetRobustnessF', 'AssetRobustnessG',
'BarterSystem', 'Beastly', 'BelowTheVeil', 'BimboBabble', 'BlushingVirgin',
'Carapacian', 'Cellulose', 'Chlorophyll', 'ClothingRestrictionA',
'ClothingRestrictionB', 'ClothingRestrictionC', 'ColdBlooded', 'Colossalable',
'ComicRelief', 'Conjoined', 'ConsentDissent', 'CreatureOfTheNight',
'CrossdressYourHeart', 'Curse2020', 'DeafeningSilence', 'DizzyingHeights',
'DoublePepperoni', 'DoubleTrouble', 'DrawingSpades', 'Eggxellent',
'EqualOpportunity', 'Erased', 'EyeOnThePrize', 'Eyescream', 'FlowerPower',
'FluffyEars', 'FluffyTail', 'FreckleSpeckle', 'FutaFun', 'GenderReversalA',
'GenderReversalB', 'GenderReversalC', 'GenderReversalD', 'GenderReversalE',
'GenderReversalF', 'GenderReversalG', 'GestationJumpstart', 'Gooey',
'HairRemoval', 'HardMode', 'HeatRut', 'Hemospectrum', 'HijinksEnsue',
'Horny', 'HypnoHappytime', 'InTheLimelight', 'IncreasedSensitivity',
'KnifeEar', 'LactationRejuvenationA', 'LactationRejuvenationB', 'Leaky',
'LibidoReinforcementA', 'LibidoReinforcementB', 'LibidoReinforcementC',
'LibidoReinforcementD', 'LibidoReinforcementE', 'LibidoReinforcementF',
'LibidoReinforcementG', 'LieDetector', 'Lightweight', 'LingualLeviathan',
'LiteralBlushingVirgin', 'Literalization', 'MassacreManicure', 'MaximumFluff',
'Megadontia', 'Minishish', 'NoseGoes', 'Null', 'Omnitool', 'PermaDye',
'Pheromones', 'PleasureRespecificationA', 'PleasureRespecificationB',
'PowerDom', 'PrincessProtocol', 'Quota', 'RainbowSwirl', 'RandomOrgasms',
'RefractoryRefactorization', 'Reptail', 'Seafolk', 'SemenDemon', 'SexSwitcheroo',
'SharedSpace', 'ShrunkenAssets', 'SleepTight', 'Softie',
'SubmissivenessRectificationA', 'SubmissivenessRectificationB', 'SweetDreams',
'TaciturnTurnaround', 'TakenForGranite', 'TattooTally', 'TheMaxim',
'TicklyTentacles', 'TippingTheScales', 'UrineReamplificationA',
'UrineReamplificationB', 'WackyWombs', 'WanderingHands', 'Weakling',
'WrigglyAntennae'
]


CHARACTER_DATA
{
	"character":{
		"id":0,"name":"Nana","cost":-1,"carry":20,"affec":0,
		"swap":false,"mindSex":"female","osex":"female",
		"obreasts":1,"desiredBreasts":1,"openis":0,"ogender":6,
		"fit":0,"oheight":165,"comfortableHeight":170,"age":18,
		"appDesc":"","fear":"","ohair":"black","oskinColor":"pale",
		"oskinType":"","oears":"normal human","oeyeColor":"blue",
		"oblood":"red","pregnantT":999999999,"due":999999999,
		"tentaclePreg":false,"lastBirth":999999999,"switched":false,
		"gestationJumps":0,"location":-1
	},
	"curses":[
		"Libido Reinforcement A","Clothing Restriction A","Shrunken Assets",
		"Hair Removal","Knife-ear","Perma-dye","Freckle Speckle","Dizzying Heights",
		"Dizzying Heights","Dizzying Heights","Dizzying Heights","Dizzying Heights",
		"Increased Sensitivity","Refractory Refactorization","Libido Reinforcement B",
		"Age Reduction A","Fluffy Ears","Fluffy Tail","Heat/Rut","Lightweight",
		"Blushing Virgin"
	],
	"state":{
		"real_age":18.022,"apparent_age":16.022,"real_gender":6,
		"apparent_gender":9.951095162802796,"penis_size":0,
		"vagina_count":1,"double_penis":false,"sex":"female",
		"wombs":1,"lactation":0,"breasts":0.9021903256055908,
		"breastsLabel":"flat","height":141.6895679725032,
		"libido":12,"subdom":0,"hair":"magenta","ears":"furry cat",
		"bodyHair":0,"skinType":"hairless, smooth","skinColor":"pale",
		"eyeColor":"blue","tail":["flowing cat"],"description":"",
		"blood":"red","genderVoice":6,"fluids":100,"lewdness":72,
		"horns":0,"inhuman":3,"eyeCount":2,"armCount":2,"legCount":2,
		"tentacles":0,"extraEyes":0,"extraMouths":0
	}
}

### CURSE NOTES ###
ShrunkenAssets -> Flat Chest
HairRemoval -> no bodily/genital hairs
KnifeEar -> essentially elf ears
FreckleSpeckle -> freckles
PermaDye -> essentially custom hair color
IncreasedSensitivity -> always blushing
FluffyEars -> animal ears
FluffyTail -> animal tail
MaximumFluff -> fur all over the skin (overrides hair removal)
CreatureOfTheNight -> forces "red eyes, fangs, pale skin" prompt
WanderingHands -> a hand is always on crotch in portrait
Leaky -> pussy juice / wet pants
TattooTally -> stomach tattoo / succubus tattoo
DrawingSpades -> spade tail (succubus tail)
Horny -> horns on the head - custom horn description
Minishish -> become tiny, size of a fairy
Colossalable -> become giant, size of a building/skyscraper
WrigglyAntennae -> antennae on persons head
Null -> no genitalia / nipples
Conjoined -> conjoined body
DoubleTrouble -> duplicate of self (essentially do 'twins')
Literalization -> become an animal (e.g. become a cat)
CrossdressYourHeart -> forces clothing of opposite gender
Curse2020 -> "garbage eyes" - forces 'unstylish' glasses
Power Dom -> more "dominant" stance
Gooey -> become unicolor goo
Sex Switcheroo -> become the opposite sex with approximate size matches (flat chest = micropenis)
Futa Fun -> gives females a penis, gives males boobs, penis size is affected by asset robustness / shrunken assets
Rainbow Swirl -> changes your skin and eye color to two distinct colors of choice
Softie -> never erect (nipples, penis)
HardMode -> always erect (nipples, penis)
Megadontia -> gives very sharp teeth
LingualLeviathan -> increases length of tongue by 30cm (12inch)
TippingTheScales -> covers your body in rigid scales of color of your choice, hair still grows through it (pubic)
Reptail -> gives a large, scaled, spiky reptile tail
MassacreManicure -> Shape claws instead of fingernails
FlowerPower -> flowers and vines sprout all over your body and replaces your hair with leaves or flower petals
Cellulose -> causes your SKIN to become green, smooth and slightly rigid, like plant matter
Carapacian -> shiny, firm carapace or exoskeleton in the color of your choice, essentially shell body armor
Eye on the Prize -> blindfold
AmpuQtie -> one arm or leg is amputated
Arm Army -> two extra arms
A Little Extra -> creates another penis or another vagina hole
Seafolk -> Replaces legs with a finned tail, creates gills above your waist
TheMaxim -> parasite xray camera showing a parasite creature in either the vagina, urethra or anus
Tickly Tentacles -> grows four octopus tentacles from your back waist
Eye-scream -> Replaces your eyes with a cyclops eye
A Mouthful -> creates one large, grinning mouth on your skin where your tummy is


ClothingRestrictionA -> Can't wear accessories
ClothingRestrictionB -> Can't wear under-clothing (underwear, bra, etc)
ClothingRestrictionC -> Can't wear outfits
(B and C = nude)


SubmissivenessRectificationX -> become more submissive (1:on knees ahego, 2:bondage ropes ahego panting)
DizzyingHeightsX -> height increases/decreases X times of 5cm (2inc) up to 5 times
LactationRejuvenationX -> increases lactation by 1 (1:little, 2:heaps)
AssetRobustnessX -> increase size by 1 per curse
AgeReductionX -> Reduce PHYSICAL age by 2 years per curse (minimum 20yo)
LibidoReinforcementX -> Increases Libido by 1 per curse, more leaking pussy juice / penis pre-ejaculate
GenderReversalX -> changes your body towards the opposite gender of your STARTING gender
	A: no changes
	B: "dainty" / "a twink"
	C: androgynous (both sexes are clearly expressed in a single individual), gender depends on your clothing
	D: more feminine/mascular
	E: (penis/chest OR vagina) are the same but you look female/male
	F: more feminine/mascular
	G: more feminine/mascular
'''

from typing import Optional
from PIL import Image
from io import BytesIO

from modals import CharacterData, SceneData
from workflows import PortraitT2IGenericWorkflow, PrepareSimpleT2IWorkflow, PortraitT2IDepthControlWorkflow, PrepareSDXLDepthWorkflow
from comfyui import ComfyUI_API

PREFIX_POSITIVE_PROMPT : str = "(masterpiece,best quality,high quality,medium quality,normal quality)"
PREFIX_NEGATIVE_PROMPT : str = "lowres, text, error, cropped, worst quality, low quality, jpeg artifacts, ugly, duplicate, morbid, mutilated, out of frame, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, blurry, dehydrated, bad anatomy, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, extra legs, fused fingers, too many fingers, long neck, username, watermark, signature"

BODY_FITNESS : list[str] = ["fragile body", "weak body", "average body", "fit body", "very fit body"]
HEIGHT_RANGES : list[tuple[str, int]] = [("dwarf",150),("midget",160),("short",170),("",183),("tall",195)]

# GENDER_REVERSAL_STAGE = ["", "dainty, twink,", "androgynous", "feminine", "female"]
PENIS_SIZES : list[str] = ["small penis", "below average penis", "average penis", "large penis", "huge penis"]

def height_to_ranged_value(height : int | float) -> str:
	for item in HEIGHT_RANGES:
		if height < item[1]:
			return item[0]
	return HEIGHT_RANGES[len(HEIGHT_RANGES)-1][0]

# PORTRAIT GENERATOR
async def prepare_portrait_prompt(
	character_data : CharacterData
) -> str:

	base_prompt = PREFIX_POSITIVE_PROMPT
	base_prompt += ",solo,portrait,upper_body,plain dark background,"

	# temporary
	base_prompt += character_data.state.sex + ","
	base_prompt += f"{max(character_data.state.apparent_age, 21)} years old,"
	base_prompt += BODY_FITNESS[max(min(character_data.character.fit+2, 4), 0)] + ","
	base_prompt += height_to_ranged_value(character_data.state.height) + ","
	base_prompt += character_data.state.hair + " hair,"
	for tail in character_data.state.tail:
		base_prompt += character_data.state.hair + " " + tail + " tail,"
	base_prompt += character_data.state.hair + " " + character_data.state.ears + " ears,"

	# CreatureOfTheNight -> Vampire
	if "CreatureOfTheNight" in character_data.curses:
		base_prompt += "vampire,fangs,red eyes,glowing eyes,pale skin,"
	else:
		base_prompt += character_data.state.eyeColor + " eyes,"
		base_prompt += character_data.state.skinColor + " skin,"

	if "WrigglyAntennae" in character_data.curses:
		base_prompt += "pink antennae,"
	if "Megadontia" in character_data.curses:
		base_prompt += "sharp teeth,"
	if "FreckleSpeckle" in character_data.curses:
		base_prompt += "freckles,"
	if "KnifeEar" in character_data.curses:
		base_prompt += "pointy ears,"
	if "Horny" in character_data.curses:
		base_prompt += "succubus horns,"
	if "DrawingSpades" in character_data.curses:
		base_prompt += "spade tail,"

	if "ClothingRestrictionA" not in character_data.curses:
		base_prompt += "earrings,"

	if "ClothingRestrictionC" not in character_data.curses:
		base_prompt += "adventurer,leather armor,"

	if "ClothingRestrictionC" in character_data.curses:
		if "ClothingRestrictionB" in character_data.curses:
			base_prompt += "nude,"
		else:
			if character_data.state.sex == "female":
				base_prompt += "bra,panties,"
			else:
				base_prompt += "underwear,shirtless,no pants,"
				base_prompt += "small penis bulge,"

	if "ClothingRestrictionC" in character_data.curses and "ClothingRestrictionB" in character_data.curses:
		# NUDE
		if "Null" in character_data.curses:
			# null curse
			base_prompt += "smooth featureless body, no genitalia, soft abstract body aesthetic without explicit details,"
		else:
			# sex-specific
			if character_data.state.sex == "female":
				# female
				if "TattooTally" in character_data.curses:
					base_prompt += "succubus tattoo,"
				if "Leaky" in character_data.curses:
					base_prompt += "pussy juice,"
			else:
				# male
				if "TattooTally" in character_data.curses:
					base_prompt += "incubus tattoo,"
				if "Leaky" in character_data.curses:
					base_prompt += "pre-ejaculation,"

			# lactation (both M/F)
			lactation : int = 0
			if "LactationRejuvenationA" in character_data.curses:
				lactation += 1
			if "LactationRejuvenationB" in character_data.curses:
				lactation += 1

			if lactation == 2:
				base_prompt += "milk,lactating,lactation,"
			elif lactation == 1:
				base_prompt += "dripping lactation,"

			if character_data.state.penis_size > 0:
				base_prompt += PENIS_SIZES[character_data.state.penis_size-1] + ","

	base_prompt += character_data.state.breastsLabel + " breasts,"

	return base_prompt

async def generate_character(
	character : CharacterData
) -> Optional[Image.Image]:
	prompt : str = await prepare_portrait_prompt(character)
	print(prompt)

	params = PortraitT2IGenericWorkflow(
		checkpoint="hassakuXLHentai_v13.safetensors",
		positive_prompt=prompt,
		negative_prompt=PREFIX_NEGATIVE_PROMPT
	)
	print(params)

	workflow = await PrepareSimpleT2IWorkflow(params)
	print(workflow)

	COMFYUI_NODE = ComfyUI_API('127.0.0.1:8188')
	await COMFYUI_NODE.is_available()
	await COMFYUI_NODE.open_websocket()

	image_array : list[dict] = await COMFYUI_NODE.generate_images_using_worflow_prompt(workflow)

	await COMFYUI_NODE.close_websocket()

	if len(image_array) == 0: return None

	raw_image : bytes = image_array[0]['image_data']
	return Image.open(BytesIO(raw_image))
